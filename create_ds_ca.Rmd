---
title: "create_ds_ca"
author: "Kriti Singh"
date: '2022-03-16'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


```{r}
install.packages("tidyverse")
library(tidyverse)

install.packages("compare")
library(compare)

install.packages("data.table")
library(data.table)

library(ggplot2)

#local directory - change to one drive directory later
setwd("H:/Menu Labeling in California")
getwd()

#set R directory to where .csv files are saved and loading all files in folder at 
#we do not want files with "_occasion"
calorie_dir = "mean-calorie-w-mod/by-restaurant-occasion"
calorie_files = list.files(path = calorie_dir, pattern = "^mean-calorie_restid_2(.*)csv$", full.names = TRUE)

calorie_files #this lists all files in specified folder - 35 files (excluding "_occasion")

#read all files and append all in one step and add filepath for each observation
#calorie_master <- bind_rows(lapply(calorie_files,read.csv)) - this does not create column with filepath

calorie_filelist <- list()
calorie_filelist <- lapply(calorie_files, function(x){
                                ret <- read.csv(x)
                                ret$origin <- x
                                return(ret)})
calorie_master <- rbindlist(calorie_filelist)

#Erilia noted that 2007 Q1 (months 204-207) - calories and macro-nutrients were double counted but count (#orders) was not

Q1_07 = "mean-calorie-w-mod/by-restaurant-occasion/mean-calorie_restid_2007_Q1.csv"

calorie_master1 <- calorie_master %>%
                      mutate(cal = ifelse(origin %in% c(Q1_07), cal/2, cal), 
                             total_fat = ifelse(origin %in% c(Q1_07), total_fat/2, total_fat),
                             carb = ifelse(origin %in% c(Q1_07), carb/2, carb),
                             protein = ifelse(origin %in% c(Q1_07), protein/2, protein),
                             sat_fat = ifelse(origin %in% c(Q1_07), sat_fat/2, sat_fat),
                             sugar = ifelse(origin %in% c(Q1_07), sugar/2, sugar),
                             fiber = ifelse(origin %in% c(Q1_07), fiber/2, fiber),
                             sodium = ifelse(origin %in% c(Q1_07), sodium/2, sodium))

#check - figure out how to check that the above code ran as we need it to
#all.equal(calorie_master, calorie_master1)

compare(calorie_master, calorie_master1)


#import analytic_restaurants file to merge with mean-calorie files
analytic_restaurants <- read.csv("restaurants/analytic_restaurants.csv", stringsAsFactors = FALSE)

#import time_day_dim
time_day_dim <- read.csv("time_day_dim.csv", stringsAsFactors = FALSE)

```

```{r}
#merge calorie_master and analytic_restaurants
mergedDs <- merge(analytic_restaurants, calorie_master1, by.x = c("restid"), by.y = c("DW_RESTID"))

CA_ds <- mergedDs %>%
            select(-restid) %>%
            filter(state == "CA") %>%
            group_by(DW_MONTH, DW_OCCASION, address, concept, ownership, tract_num) %>%
            mutate(cal = sum(cal), 
                      total_fat = sum(total_fat), 
                      carb = sum(carb), 
                      protein = sum(protein), 
                      sat_fat = sum(sat_fat), 
                      sugar = sum(sugar), 
                      fiber = sum(fiber), 
                      sodium = sum(sodium), 
                      count = sum(count)) %>%
            ungroup() 

#create restaurant_id and arrange
CA_ds$restaurant_id <- CA_ds %>% group_indices(address, concept, ownership, tract_num) 
            
arrange(CA_ds, desc(DW_MONTH), DW_OCCASION) #this doesn't work how I would like for it to
```

